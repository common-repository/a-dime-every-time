<?php
function welcome(){
		?>
		<div style="background-color: #DDD; border-top-left-radius: 1em; border-top-right-radius: 1em; padding:1em; border-bottom:1px solid #eee;">
			<table>
				<tr>
					<td><img style="vertical-align: middle;" width="130" src="../wp-content/plugins/a-dime-every-time/img/dime_logo.png"/></td>
					<td>
						<div style="padding: 0.5em; padding-left: 2em; color: #666; font-size: 150%; line-height: 150%;">		
							<h1 style="color:#888"><?php _e('Settings', 'bachbill');?></h1>
							<?php _e('Welcome to the ADimeEveryTime plugin. It will allow you to monetize your Wordpress website very easily', 'bachbill');?>.
							<?php _e('To configure it you only need to follow three steps', 'bachbill');?>:
						</div>
					</td>
				</tr>
			</table>			
		</div>
		<?
	}
	function whatever(){// !!! no clue why, but in mac, if default php.ini is used, next termsAndConditions() function contents are displayed regardless even if function gets called...
		?>

<?php 
}

function termsAndConditions(){
		?>
		<textarea readonly="readonly" rows="10" cols="80">
Welcome to ADimeEveryTime. This is the ADimeEveryTime platform 
(the "Service") through the website
bachbill.com and/or related websites (collectively, the "Site").
   * By registering for or using an account for the Service
("Account"), you (1) agree to the following terms and conditions of
this service agreement (the "Service Agreement") on behalf of yourself
and the company or organization identified as the Account holder
during the registration for the Service (a "Registrant"), (2)represent
and warrant that you are authorized to accept this Service Agreement
on behalf of the Registrant, and (3) agree that such Registrant will
be responsible for the acts and omissions of any individual users who
register for or use the Account.

Further, by agreeing to the Service Agreement, you also agree to the
bachbill.com Website Terms of Use. If you do not agree to the
following Service Agreement, do not use the Service.

Bachbill, Ltd. ("Bachbill") reserves the right to modify or replace
this Service Agreement at any time and in Bachbill's sole discretion.
Bachbill will indicate at the top of this Service Agreement the date
such document was last updated. Any changes will be effective
immediately upon posting the revised version on the Site (or such
later effective date as may be indicated at the top of the revised
Service Agreement). Your continued use of the Service following the
posting of any changes to this Service Agreement will constitute your
acceptance of such changes. If you do not agree to the changes, you
must stop using the Service. In addition, Bachbill may provide other
methods by which you may accept this Service Agreement or changes to
this Service Agreement.

1. Privacy Policy. Please refer to our Privacy Policy for information
on how Bachbill collects, uses and discloses personal information.

2. Registration; Account Security. Account registration is required to
use the Service. Bachbill reserves the right to refuse registration,
or to refuse or limit access to the Service or any features, to anyone
in its sole discretion. You will provide accurate, current and
complete information (including about Registrant and Registrant's
users) in any registration or other Account-related forms on the Site
("Registrant Information") and agree to maintain the security of your
username(s) and password(s). You will maintain and promptly update the
Registrant Information to keep it accurate, current and complete. YOU
UNDERSTAND THAT ANY PERSON WITH YOUR USERNAME(S) AND PASSWORD(S) MAY
BE ABLE TO ACCESS YOUR ACCOUNT (INCLUDING REGISTRANT INFORMATION,
EXPENSE REPORT DATA, TRANSACTION INFORMATION, AND OTHER USER DATA
(COLLECTIVELY, "CONTENT") YOU OR OTHERS HAVE PROVIDED TO CONCUR). YOU
ACCEPT ALL RISKS OF UNAUTHORIZED ACCESS TO YOUR ACCOUNT BASED ON THE
SHARING OR LOSS OF A USERNAME AND PASSWORD. You will promptly notify
Bachbill if you discover or otherwise suspect any security breaches
related to the Site, including any unauthorized use or disclosure of a
username or password.

3. Grant of Rights; Ownership; Use Restrictions.
3.1 Grant of Rights. Subject to the terms of this Service Agreement:
(a) Bachbill hereby grants Registrant a non-exclusive,
non-transferable, worldwide right during the term of the Service
Agreement to access and use the Service solely for Registrant's
internal business or commercial purposes as contemplated by this
Service Agreement; and (b) Registrant hereby grants Bachbill a
non-exclusive, worldwide right (i) to use all Content as necessary to
provide the Service, and (ii) to create aggregated or redacted forms
of Content that do not identify Registrant or any users of an Account
("Aggregated Content") for Bachbill's business purposes.
3.2 Ownership. Subject to the rights granted to Registrant above,
Bachbill and its licensors and suppliers own and retain all right,
title, and interest in and to the following (collectively, "Bachbill
Property"): (a) the Service, the Site, and all other software,
hardware, technology, documentation, and information provided by
Bachbill in connection with the Service; (b) all Aggregated Content;
(c) all ideas, know-how, and techniques that may be developed,
conceived, or invented by Bachbill during its performance under this
Service Agreement; and (d) all worldwide patent, copyright, trade
secret, trademark and other intellectual property rights in and to the
property described in clauses (a), (b) and (c) above. Subject to the
rights granted to Bachbill above, Registrant owns and retains all
right, title, and interest in and to the Content and all intellectual
property rights therein.
3.3 Restrictions. Except as expressly permitted under this Service
Agreement, Registrant shall not directly or indirectly do any of the
following: (a) access, use, sell, distribute, sublicense, broadcast,
or commercially exploit any Bachbill Property or any rights under the
Service Agreement, including without limitation any access or use of
any Bachbill Property on a service bureau basis or for any Registrant
processing services beyond the scope specified in this Agreement (such
as for any third parties on a rental or sharing basis); (b) introduce
any infringing, obscene, libelous, or otherwise unlawful data or
material into the Service; (c) copy, modify, or prepare derivative
works based on Bachbill Property; (d) reverse engineer, decompile,
disassemble, or attempt to derive source code from any Bachbill
Property; or (e) remove, obscure, or alter any intellectual property
right or confidentiality notices or legends appearing in or on any
aspect of any Bachbill Property.

4. Warranties and Limitations.
4.1 Warranty. Registrant each hereby represents, warrants, and
covenants to Bachbill that: (a) it has the authority to enter into
this Service Agreement, to grant the rights granted by it under this
Service Agreement, and to perform its obligations under this Service
Agreement; (b) it will comply with all applicable laws and regulations
that may be in effect during the term of this Service Agreement as
they apply to Registrant's obligations under this Service Agreement;
and (c) the Content, and the use thereof by Bachbill, does not and
will not infringe, or constitute an infringement or misappropriation
of, any intellectual property rights, privacy rights or other
proprietary rights of a third party or breach the terms of any
agreement with a third party.
4.2 Disclaimer of Warranties. THE SERVICE IS PROVIDED "AS IS," WITHOUT
WARRANTIES OF ANY KIND. CONCUR DISCLAIMS ALL REPRESENTATIONS,
WARRANTIES, CONDITIONS, AND GUARANTIES OF ANY KIND, EITHER EXPRESS OR
IMPLIED, ORAL OR WRITTEN, WITH RESPECT TO THE SERVICE OR ANY OTHER
ITEMS OR SERVICES COVERED BY OR FURNISHED UNDER THIS SERVICE
AGREEMENT, INCLUDING WITHOUT LIMITATION ANY IMPLIED WARRANTY (a) OF
MERCHANTABILITY, (b) OF FITNESS FOR A PARTICULAR PURPOSE, OR (c)
ARISING FROM COURSE OF PERFORMANCE, COURSE OF DEALING, OR USAGE OF
TRADE. CONCUR DOES NOT WARRANT THAT ANY ITEMS OR SERVICES WILL BE
UNINTERRUPTED OR ERROR FREE.
4.3 Limitation of Liability. IN NO EVENT WILL CONCUR BE LIABLE FOR ANY
DIRECT, INDIRECT, SPECIAL, INCIDENTAL, CONSEQUENTIAL, PUNITIVE, OR
EXEMPLARY DAMAGES IN CONNECTION WITH THIS SERVICE AGREEMENT, HOWEVER
CAUSED AND UNDER WHATEVER THEORY OF LIABILITY, EVEN IF CONCUR HAS BEEN
ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.

5. Indemnification.
5.1 By Registrant. Registrant shall indemnify and hold harmless
Bachbill and its parent and affiliate companies, and their directors,
officers, employees, agents, successors and assigns from and against
any and all loss, damage, liability, and expense arising from any
claim brought against any such indemnified party by any third party to
the extent: (a) alleging that the Content, or Registrant's use of the
Service (if in violation of the terms of this Service Agreement),
infringes upon any patent, copyright, trademark, privacy, trade
secret, or other proprietary right of, or otherwise harms, any third
party or breaches a contract with any third party; or (b) resulting
from the failure of Registrant to comply with its obligations under
this Service Agreement or from the acts or omissions of Registrant or
its employees, agents, Account users, and affiliates, and each of the
successors and assigns of the above persons or entities.
5.2 Defense; Procedure. For any indemnifiable claim described in this
Section 5, at Bachbill's election upon notice to Registrant,
Registrant shall, at its expense, defend any such claim, provided
that, if any settlement requires any obligation of an indemnified
party, then such settlement shall require Bachbill's prior written
consent. Bachbill may assume exclusive control over the defense of
any such claim at any time by not electing to have Registrant assume
responsibility for such defense or, if such election has been made, by
giving notice to Registrant of Bachbill's resumption of exclusive
control over such defense. If any compromise or settlement is made
with respect to such claim, Registrant shall pay all amounts in
settlement of such claim.

6. Data Security. Bachbill will use reasonable efforts to establish
and maintain safeguards to protect the security and integrity of the
Service and protect against the accidental or unauthorized access,
use, alteration or disclosure of the Content. Except with your consent
or as otherwise permitted under Section 3.1(b) of this Service
Agreement, Bachbill will not use the Content other than to provide
the Service.

7. Term and Termination
7.1 Term. The term of this Service Agreement will commence when you
register for an Account and will continue until terminated in
accordance with this Service Agreement. Bachbill reserves the right
to terminate this Service Agreement at any time, with or without cause
and in its sole discretion, immediately upon written notice (which may
be by email) or by terminating an Account and redirecting login
attempts to a notice regarding such termination. This Service
Agreement will automatically terminate upon the end of the limited
period of time we specified for free trial use on the Site or
Registrant's subscription for use the Service under a separate service
agreement.
7.2 Effect of Termination. Upon termination of this Service Agreement,
all rights granted to Registrant under this Service Agreement shall
immediately terminate, including the right to access and use the
Service by all of Registrant's users, unless the termination is due to
Registrant's subscription for use of the Service under a separate
service agreement. Termination of this Service Agreement shall not be
construed to waive or release any claim that a party is entitled to
assert at the time of such termination, and the applicable provisions
of this Service Agreement shall continue to apply to such claim until
it is resolved. Without limiting the foregoing, Sections 3.1(b), 3.2,
3.3, 4, 5, 7.2 and 8 of Service Agreement shall survive the
termination of this Service Agreement for any reason.

8. Miscellaneous
8.1 Relationship of Parties. Bachbill and Registrant are independent
contractors and this Service Agreement will not establish any
relationship of partnership, joint venture, employment, franchise, or
agency between Bachbill and Registrant. Registrant shall not, and
will have no power to, bind Bachbill or incur obligations on
Bachbill's behalf.
8.2 Assignment. Registrant may not assign or transfer this Service
Agreement without the prior written consent of Bachbill, and any
attempted assignment without such consent will be void. Bachbill may
assign or transfer this Service Agreement at any time. Subject to the
foregoing restriction on Registrant, this Service Agreement is binding
on the parties hereto and their respective successors and permitted
assigns.
8.3 Waiver and Severability. Bachbill's failure to enforce any term
or condition of this Service Agreement shall not be deemed a waiver of
the right to later enforce such term or condition or any other term or
condition of this Service Agreement. If any provision of this Service
Agreement is found to be void or unenforceable, that provision will be
enforced to the maximum extent possible, and the remaining provisions
of this Service Agreement will remain in full force and effect.
8.4 Excused Performance. Bachbill shall not be liable for any delay
or failure to perform due to causes beyond its reasonable control.
8.5 Entire Agreement. This Service Agreement contains the entire
agreement and understanding between Bachbill and Registrant with
respect to the subject matter thereof and supersedes all prior
agreements, negotiations, representations, and proposals, written and
oral, relating to such subject matter.
8.6 Amendments. This Service Agreement shall not be deemed or
construed to be modified, amended, or waived, in whole or in part,
except as set forth above or by a separate written agreement duly
executed by the parties to this Service Agreement.
8.7 Governing Law and Venue; Arbitration. This Service Agreement shall
be governed by and construed in accordance with the laws of the State
of Texas USA, applicable to agreements made and to be entirely
performed within the State of Texas USA, without resort to its
conflict of law provisions. Any claim, dispute, or controversy related
to or arising out of this Service Agreement or the Service shall be
resolved exclusively by binding arbitration pursuant to the Commercial
Arbitration Rules ("AAA Rules") of the American Arbitration
Association ("AAA"), but the parties do not necessarily intend for the
AAA to administer the arbitration. The arbitration will take place in
Austin, Texas and the internal laws of the State of Texas (other than
conflicts of laws rules) and of the United States of America shall
apply. Part or all of the arbitration may be conducted by telephone or
based on written submissions, and will not require the personal
appearance of the parties or any witnesses unless otherwise agreed by
the parties. The allocation of costs and fees for such arbitration
shall be determined in accordance with the AAA Rules. If such costs
are finally determined to be excessive in a consumer dispute,
Bachbill will be responsible for paying all arbitration fees and
arbitrator compensation in excess of what is deemed reasonable. The
arbitration shall be conducted by a single, neutral arbitrator engaged
in the practice of law who is mutually agreed upon by the parties or
failing such agreement within 14 days from the delivery of the
original arbitration demand, each party shall select one arbitrator
and the two selected arbitrators shall mutually agree upon the
selection of a third arbitrator within 30 days from the delivery of
the original arbitration demand. The arbitrator's decision and award
shall be final and binding and may be entered in any court with
jurisdiction. Nothing in this Service Agreement will prevent a party
from seeking injunctive or other equitable relief with respect to the
infringement, misappropriation or other violation of such party's
intellectual property or other proprietary rights in any court of
competent jurisdiction. In the event the foregoing agreement to
arbitrate is deemed unlawful, void, or for any reason unenforceable
with respect to any claim, dispute or controversy, then you agree that
any such claim, dispute or controversy shall be filed and adjudicated
only in the state and federal courts located in Travis County, Texas
and Registrant hereby irrevocably and unconditionally consents and
submits to the exclusive jurisdiction of such courts over any suit,
action or proceeding arising out of this Service Agreement.
8.9 Interpretation. This Service Agreement will not be construed in
favor of or against any party by reason of the extent to which any
party participated in the preparation of this Service Agreement.
			</textarea>
		<?php
	}
	function bachbill_general_options() {
		?>
		<style>
			.bachbill_option {
				float: left;
				padding: 0.5em;
				background-color:#eee;
				margin: 0.5em;
				border-radius: 3px;
			}
			.bachbill_option:hover {
				background-color:#fff;
				box-shadow: #fff 0px 0px 15px;
				
			}
		</style>
		<div style="margin:2em; padding: 2em; background-color: #EEE; border-radius: 1em; ">
		<?php
		$accountSetup=get_option('bachbill_account_setup'); // null or unready, pendingCode or ready
//		echo '$accountSetup: '.$accountSetup;
		$mode=$_GET['mode'];
		if (!$mode){
			?>
			<script>
				function resetConfig(){
					if (confirm("<?php _e('Are you sure that you want to reset all the information and start configuring the plugin again?', 'bachbill');?>")){
						document.location.href='admin.php?page=a-dime-every-time/admin.php&mode=reset';
					}
				}
			</script>
			<?php
			if (!$accountSetup || $accountSetup=='unready'){
				?>
				<script>
				function toggleDiv2(id){
					document.getElementById('account_info2').style.display=document.getElementById('account_info2').style.display=='none'?'':'none'
				}
				</script>
				<?php
					welcome(); 
				?>
				<br/>
				<div class="bachbill_option">
					<img width="30" style="vertical-align: middle" src="../wp-content/plugins/a-dime-every-time/img/register.png"/> <a href="javascript:toggleDiv2('account_info')">1.- <?php _e('Account information', 'bachbill');?>...</a>
				</div>
				<div style="clear: both;"></div>
				<div id="account_info2" style="padding: 20px; display:none;  width: 80%;background-color: #EEE; border-radius: 1em; box-shadow: #888 6px 6px 15px;">
					<form name="ask" method="post" action="admin.php?page=a-dime-every-time/admin.php&mode=askSignup">
						<table>
						<tr><td colspan="3"><img src="../wp-content/plugins/a-dime-every-time/img/register.png"/> <?php _e('You need a ADimeEveryTime account to configure the plugin and start making money', 'bachbill');?></td></tr>
						<tr>
							<td colspan="3">
							<br/><br/>
							<b><?php _e('Would you like to sign up for ADimeEveryTime?', 'bachbill');?></b><br/><br/>
									<input type="radio" name="acc" value="no" checked="no"/>&nbsp;&nbsp;<?php _e('Yes, I would like to sign up', 'bachbill');?><br/><br/>
									<input type="radio" name="acc" value="yes"/>&nbsp;&nbsp;<?php _e('No, I already have a ADimeEveryTime account', 'bachbill');?><br/>
							</td>
						</tr>
						<tr><td align="right" colspan="3" width="100%"><input class="button-primary" type="submit" value="<?php _e('Continue', 'bachbill');?>"/></td></tr>
						</table>
					</form>
				</div>
				<?php if (!$accountSetup || $accountSetup=='unready'){?>
               <img width="30" style="vertical-align: middle" src="../wp-content/plugins/a-dime-every-time/img/revenue-share.png"/> 2.- <?php _e('Payments', 'bachbill');?>...<br/><br/>
               <img width="30" style="vertical-align: middle" src="../wp-content/plugins/a-dime-every-time/img/snetworks.jpg"/> 3.- <?php _e('Social networks', 'bachbill');?>...<br/><br/>
               <?php
				} 
               ?>
				<?php 
				return;
			}else if ($accountSetup=='pendingSignup'){
				?>
				<br/><br/>
				<img style="vertical-align: middle;" width="200" src="../wp-content/plugins/a-dime-every-time/img/dime_logo.png"/><br/>
				
				<div style="padding: 50px">
					<h1><?php _e('Signup', 'bachbill');?></h1>
					<form method="post" action="admin.php?page=a-dime-every-time/admin.php&mode=signup">
						<table>
							<tr>
								<td><?php _e('User ID', 'bachbill');?></td>
								<td><input style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="id" value=""/></td>
							</tr>
							<tr>
								<td><?php _e('User Name', 'bachbill');?></td>
								<td><input style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="name" value=""/></td>
							</tr>
							<tr><td colspan="2"><br/></td></tr>
							<tr>
								<td><?php _e('E-mail address', 'bachbill');?></td>
								<td><input style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="email" value=""/></td>
							</tr>
							<tr>
								<td><?php _e('Retype E-mail address', 'bachbill');?></td>
								<td><input style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="email_retype" value=""/></td>
							</tr>
							<tr><td colspan="2"><br/></td></tr>
							<tr>
								<td><?php _e('Password', 'bachbill');?></td>
								<td><input style="border: 2px solid #0088dd; background-color: #eeeeee" type="password" name="password" value=""/></td>
							</tr>
							<tr>
								<td><?php _e('Retype Password', 'bachbill');?></td>
								<td><input style="border: 2px solid #0088dd; background-color: #eeeeee" type="password" name="password_retype" value=""/></td>
							</tr>
						</table>
						<br/>
									<?php termsAndConditions()?>
						<b><br/><br/>&nbsp;&nbsp;&nbsp;</b><input type="checkbox" name="agree" value="yes"> <?php _e('Yes, I agree on the terms and conditions', 'bachbill');?></input><br/><br/>
							<br/>
							<input class="button-primary" type="submit" value="<?php _e('Signup', 'bachbill');?>"/><br/><br/>
						<input type="button" name="" class="button-secondary action" value="<?php _e('Go back', 'bachbill');?>" onClick="document.location.href='admin.php?page=a-dime-every-time/admin.php&mode=reset';">
					</form>
				</div>
				<?php 
				return;
			}else if ($accountSetup=='pendingCode'){
				$resendCode=$_GET['resendCode']=='true';
				?>
					<br/><br/>
					<img style="vertical-align: middle;" width="200" src="../wp-content/plugins/a-dime-every-time/img/dime_logo.png"/><br/>
					<h2><?php _e('Thanks for signing up', 'bachbill');?>.</h2><br/>
					<?php
					if ($resendCode){
						global $API_URL;
						$partnerId=get_option('bachbill_adminUserId');
						$url=$API_URL.'/bachbill/dispatch?activity=signup&action=resend_code_wordpress&partnerId='.$partnerId;
						$postBody='partnerId='.$partnerId;
						$api=getBachbillApi();
						$result=$api->callUrl($url, 'post', $postBody, true);
			
			
						if ($api->hasErrors()){
							renderAdminError($api->getErrorMessage());
							return;
						}
						?>
						<span style="color: #666; font-size: 14pt"><?php _e('The confirmation code was resent to your email address', 'bachbill');?></span><br/><br/>
						<?php 
					}
					
					?>
					<form method="post" action="admin.php?page=a-dime-every-time/admin.php&mode=confirmSignup">
						<?php _e('You need to activate you account', 'bachbill');?>.<br/><br/>
						<?php _e('You should have received a confirmation code by email. Please type it here', 'bachbill');?>: <input style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="code" value=""/>
						<input class="button-primary" type="submit" value="<?php _e('Click to continue with the setup', 'bachbill');?>"/><br/><br/>
						<img src="../wp-content/plugins/a-dime-every-time/img/refresh.png" style="vertical-align: middle"/> <a href="admin.php?page=a-dime-every-time/admin.php&resendCode=true"><?php _e('Please resend me the confirmation code', 'bachbill');?></a>
					</form>
					<br/><br/>
					<input type="button" name="" class="button-secondary action" value="<?php _e('Reset all the information', 'bachbill');?>" onClick="resetConfig()">
				<?php 
			}else if ($accountSetup=='ready'){
				// later
			}
		}else if ($mode=='askSignup'){
			$acc=$_POST['acc'];
			if ($acc=='yes'){
				update_option('bachbill_account_setup', 'ready');
				?>
				<script>document.location.href='admin.php?page=a-dime-every-time/admin.php';</script>
				<?php 
				return;
			}else {
				update_option('bachbill_account_setup', 'pendingSignup');
				?>
				<script>document.location.href='admin.php?page=a-dime-every-time/admin.php';</script>
				<?php 
				return;
			}
		}else if ($mode=='reset'){
			update_option('bachbill_account_setup', 'unready');
			?>
			<script>document.location.href='admin.php?page=a-dime-every-time/admin.php';</script>
			<?php 
			return;
		}else if ($mode=='signup'){
			global $API_URL;
			$id=$_POST['id'];
			$email=$_POST['email'];
			$emailRetype=$_POST['email_retype'];
			$password=$_POST['password'];
			$passwordRetype=$_POST['password_retype'];
			$name=$_POST['name'];
			$agree=$_POST['agree'];
			$url=$API_URL.'/bachbill/dispatch?activity=signup&action=signup_wordpress';
			$postBody='&email='.$email.'&id='.$id.'&password='.$password.'&name='.$name.'&agree='.$agree;
			$api=getBachbillApi();
			if (strlen($id)==0){
				renderAdminError(__('No User ID present', 'bachbill'));
				return;
			}
			if (strlen($name)==0){
				renderAdminError(__('No Name present', 'bachbill'));
				return;
			}
			if (strlen($email)==0){
				renderAdminError('No email present');
				return;
			}
			if (strlen($email)==0 || $email!=$emailRetype){
				renderAdminError(__('Emails do not match', 'bachbill'));
				return;
			}	
			if (strlen($password)==0 || $password!=$passwordRetype){
				renderAdminError(__('Passwords do not match', 'bachbill'));
				return;
			}
			if ($agree!='yes'){
				renderAdminError(__('You must agree on the terms and conditions', 'bachbill'));
				return;
			}
			$result=$api->callUrl($url, 'post', $postBody, true);


			if ($api->hasErrors()){
				renderAdminError($api->getErrorMessage());
				return;
			}
			update_option('bachbill_adminAreaId', $id.'_admin_area');
			update_option('bachbill_adminUserId', $id);
			update_option('bachbill_adminUserPassword', $password);
			update_option('bachbill_endUserAreaId', $id.'_end_user_area');
			update_option('bachbill_priceplanId', $id.'_priceplan');
			update_option('bachbill_account_setup', 'pendingCode');
			?>
			<script>document.location.href='admin.php?page=a-dime-every-time/admin.php';</script>
			<?php 
			return;
		}else if ($mode=='confirmSignup'){
			global $API_URL;
			$url=$API_URL.'/bachbill/dispatch?activity=signup&action=confirm_wordpress';
			$partnerId=get_option('bachbill_adminUserId');
			$postBody='partnerId='.$partnerId.'&signupKey='.$_POST['code'];
			$api=getBachbillApi();
			$result=$api->callUrl($url, 'post', $postBody, true);


			if ($api->hasErrors()){
				renderAdminError($api->getErrorMessage());
				return;
			}
			$adminAreaId=get_option('bachbill_adminAreaId');
			$adminUserId=get_option('bachbill_adminUserId');
			$adminUserPassword=get_option('bachbill_adminUserPassword');
			$endUserAreaId=get_option('bachbill_endUserAreaId');
			$priceplanId=get_option('bachbill_priceplanId');
			$api=getBachbillApi();
			$api->setAdminAreaId($adminAreaId);
			$api->setAdminUserId($adminUserId);
			$api->setAdminUserPassword($adminUserPassword);
			$api->setParam('action', 'set');
			$api->setParam('paypalEnvironment', 'sandbox');
			$api->setParam('paypalApiUsername_sandbox', 'sdk-three_api1.sdk.com');
			$api->setParam('paypalApiPassword_sandbox', 'QFZCWN5HZM8VBG7Q');
			$api->setParam('paypalApiSignature_sandbox', 'A.d9eRKfd1yVkRrtmMfCFLTqa6M9AyodL0SJkhYztxUi8W9pCXF6.4NI');
			$api->setParam('paypalApiUsername_live', '');
			$api->setParam('paypalApiPassword_live', '');
			$api->setParam('paypalApiSignature_live', '');
			$api->setParam('currency', 'EUR');
			$api->setParam('taxPercentage', '0');
			update_option('bachbill_taxPercentage', '0');
			$res=$api->callOnIncomingUrlAction($priceplanId, '/pushConfig');
			if ($api->hasErrors()){
				?>
				<script>alert("<?php echo $api->getErrorMessage();?>");</script>
				<span style="color: red; font-size: 18pt"><?php echo $api->getErrorMessage();?><br/><br/></span>
				<?php 
			}
			update_option('bachbill_account_setup', 'ready');
			?>
			<script>document.location.href='admin.php?page=a-dime-every-time/admin.php&showPaymentOptions=true';</script>
			<?php 
			return;
		}
		
		if ($accountSetup=='ready'){

				
				$error='';
				$action=$_POST['action'];
				$action=$action?$action:$_GET['action'];
				$socialNetworks=get_option('bachbill_social_networks');
				$paymentMethods=get_option('bachbill_paymentMethods');
				if ($action==='configure'){
								
					update_option('bachbill_adminAreaId', $_POST['adminAreaId']);
					update_option('bachbill_adminUserId', $_POST['adminUserId']);
					update_option('bachbill_adminUserPassword', $_POST['adminUserPassword']);
					update_option('bachbill_endUserAreaId', $_POST['endUserAreaId']);
					update_option('bachbill_priceplanId', $_POST['priceplanId']);
					update_option('bachbill_useSSL', false);
					update_option('bachbill_currency', $_POST['currency']);
					update_option('bachbill_taxPercentage', $_POST['taxPercentage']);
					foreach ($socialNetworks as $key=>$value) {
						$socialNetworks[$key]=isset($_POST[$key]) ? true : false;
					}
					$nPayments=0;
					foreach ($paymentMethods as $key=>$value) {
						$paymentMethods[$key]=isset($_POST[$key]) ? true : false;
						if ($paymentMethods[$key]){
							$nPayments++;
						}
					}
					update_option('bachbill_social_networks', $socialNetworks);
					update_option('bachbill_paymentMethods', $paymentMethods);
				}
				if (!$socialNetworks){
					$socialNetworks=array("facebook"=>true, "google"=>true, "twitter"=>true, "linkedin"=>true, "yahoo"=>true);
					update_option('bachbill_social_networks', $socialNetworks);
				}
				$paymentMethods=array("paypal"=>true, "creditCards"=>false);
				update_option('bachbill_paymentMethods', $paymentMethods);
				$adminAreaId=get_option('bachbill_adminAreaId');
				$adminUserId=get_option('bachbill_adminUserId');
				$adminUserPassword=get_option('bachbill_adminUserPassword');
				$endUserAreaId=get_option('bachbill_endUserAreaId');
				$priceplanId=get_option('bachbill_priceplanId');
				$useSSL=get_option('bachbill_useSSL');
				$currency=get_option('bachbill_currency');
				
				$api=getBachbillApi();
				$api->setAdminAreaId($adminAreaId);
				$api->setAdminUserId($adminUserId);
				$api->setAdminUserPassword($adminUserPassword);
				if ($action=='configure'){
					$api->setParam('action', 'set');
					$api->setParam('paypalEnvironment', $_POST['paypalEnvironment']);
					$api->setParam('paypalApiUsername_sandbox', 'sdk-three_api1.sdk.com');
					$api->setParam('paypalApiPassword_sandbox', 'QFZCWN5HZM8VBG7Q');
					$api->setParam('paypalApiSignature_sandbox', 'A.d9eRKfd1yVkRrtmMfCFLTqa6M9AyodL0SJkhYztxUi8W9pCXF6.4NI');
					$api->setParam('paypalApiUsername_live', $_POST['paypalApiUsername_live']);
					$api->setParam('paypalApiPassword_live', $_POST['paypalApiPassword_live']);
					$api->setParam('paypalApiSignature_live', $_POST['paypalApiSignature_live']);
					$api->setParam('currency', $_POST['currency']);
					$taxPercentage=$_POST['taxPercentage'];
					$taxPercentage=$taxPercentage==''?0:$taxPercentage;
					$api->setParam('taxPercentage', $taxPercentage);
				}else {
					$api->setParam('action', 'get');
				}
				$res=$api->callOnIncomingUrlAction($priceplanId, '/pushConfig');
				if ($api->hasErrors()){
					?>
					<script>alert("<?php echo $api->getErrorMessage();?>");</script>
					<span style="color: red; font-size: 18pt"><?php echo $api->getErrorMessage();?><br/><br/></span>
					<?php 
				}
				$res=$res['config'];
				$paypalEnvironment=$res['paypalEnvironment'];
				$paypalEnvironment=!$paypalEnvironment?'sandbox':$paypalEnvironment;
				$paypalApiUsername_sandbox=$res['paypalApiUsername__sandbox'];
				$paypalApiPassword_sandbox=$res['paypalApiPassword__sandbox'];
				$paypalApiSignature_sandbox=$res['paypalApiSignature__sandbox'];
				$paypalApiUsername_live=$res['paypalApiUsername__live'];
				$paypalApiPassword_live=$res['paypalApiPassword__live'];
				$paypalApiSignature_live=$res['paypalApiSignature__live'];
				$taxPercentage=$res['taxPercentage'];
				$currency=$res['currency'];
				
				
			?>
			
			<style>
				td {padding-left: 20px}
			</style>
			<script>
				function validateConfig(form){
					if ((form.taxPercentage.value-form.taxPercentage.value!=0) || form.taxPercentage.value<0 || form.taxPercentage.value>100){
						alert("Invalid tax percentage");
						return false;
					}
					
					var f=true;
					return f;
				}
				function autofillFields(f){
					if (f.adminUserId.value!=""){
						if (f.adminAreaId.value==""){
							f.adminAreaId.value=f.adminUserId.value+"_admin_area";
						}
						if (f.endUserAreaId.value==""){
							f.endUserAreaId.value=f.adminUserId.value+"_end_user_area";
						}
						if (f.priceplanId.value==""){
							f.priceplanId.value=f.adminUserId.value+"_priceplan";
						}
					}
				}
				
				function showDiv(id){
					document.getElementById(id).style.display='';
				}
				function hideDiv(id){
					document.getElementById(id).style.display='none';
				}
				var configChanged=false;
				function toggleDiv(id){
					configChanged=true;
					document.getElementById('account_info').style.display='none';
					document.getElementById('payments_info').style.display='none';
					document.getElementById('social_info').style.display='none';
					document.getElementById(id).style.display='';
				}
				function manageBachbillCredit(){
					var msg="<?php _e('Changes will get lost. You can press \'Update Changes\' and then go to manage your credit.\nAre you sure you want to quit this page?', 'bachbill');?>"
					if (configChanged && !confirm(msg)){
						return;
					}
					document.location='<?php global $API_URL;echo $API_URL;?>/bachbill/dispatch?activity=credit&action=form&partnerId=<?php echo $adminUserId;?>';
				}
			</script>
				<?php
					welcome(); 
				?>
			
					<form id="f" style="background-color:#ccc; border-top: 1px solid #bbb; padding: 1em;" onSubmit="return validateConfig(this)" method="post" name="f" action="admin.php?page=a-dime-every-time/admin.php">
						<input type="hidden" name="action" value="configure"/>
						<br/><br/>
						<?php
							if (!$error && $action==='configure'){
								?><div style="width: 50%; text-align: center; color: #666; font-size: 15px"><?php _e('Configuration updated', 'bachbill');?></div><br/><br/><br/><?php 
							}
							if ($error){
								?><div style="width: 50%; text-align: center; color: #666; font-size: 15px"><?php echo $error ?></div><br/><br/><br/><?php
							} 
						?>
						
						
						
						<div class="bachbill_option">
							<img width="30" style="vertical-align: middle" src="../wp-content/plugins/a-dime-every-time/img/register.png"/><a href="javascript:toggleDiv('account_info')">1.- <?php _e('Account information', 'bachbill');?>...</a>
						</div>
						<div class="bachbill_option">
							<img width="30" style="vertical-align: middle" src="../wp-content/plugins/a-dime-every-time/img/revenue-share.png"/> <a href="javascript:toggleDiv('payments_info')">2.- <?php _e('Payments...', 'bachbill');?></a>
						</div>
						<div class="bachbill_option">
							<img width="30" style="vertical-align: middle" src="../wp-content/plugins/a-dime-every-time/img/snetworks.jpg"/> <a href="javascript:toggleDiv('social_info')">3.- <?php _e('Social networks', 'bachbill');?>...</a>											
						</div>
						
						<div style="clear: both;"></div>
						
						<div id="account_info" style="padding: 20px; display:none;  width: 80%;background-color: #EEE; border-radius: 1em; box-shadow: #888 6px 6px 15px;">
							<table>
							<tr><td>adminUserId: </td><td><input style="border: 2px solid #0088dd; background-color: #fff" type="text" size="30" name="adminUserId" value="<?php echo $adminUserId;?>" onBlur="autofillFields(this.form)"/></td><td> <?php _e('Normally it\'s', 'bachbill');?> <?php _e('the partner id', 'bachbill');?></td></tr>
							<tr><td>adminAreaId: </td><td><input style="border: 2px solid #0088dd; background-color: #fff" type="text" size="30" name="adminAreaId" value="<?php echo $adminAreaId;?>"/></td><td> <?php _e('Normally it\'s', 'bachbill');?> <i>partnerId</i>_admin_area</td></tr>
							<tr><td>adminUserPassword: </td><td><input style="border: 2px solid #0088dd; background-color: #fff" type="password" size="30" name="adminUserPassword" value="<?php echo $adminUserPassword;?>"/></td><td> <?php _e('Normally it\'s', 'bachbill');?> <?php _e('the partner password', 'bachbill');?></td></tr>
							<tr><td>endUserAreaId: </td><td><input style="border: 2px solid #0088dd; background-color: #fff" type="text" size="30" name="endUserAreaId" value="<?php echo $endUserAreaId;?>"/></td><td> <?php _e('Normally it\'s', 'bachbill');?> <i>partnerId</i>_end_user_area</td></tr>
							<tr><td>priceplanId: </td><td><input style="border: 2px solid #0088dd; background-color: #fff" type="text" size="30" name="priceplanId" value="<?php echo $priceplanId;?>"/></td><td> <?php _e('Normally it\'s', 'bachbill');?> <i>partnerId</i>_priceplan</td></tr>
							</table>
							<br/>
							<table width="100%">
							<tr><td align="left" colspan="3"><input class="button-primary" type="submit" value="<?php _e('Update configuration', 'bachbill');?>"/></td></tr>
							</table>
						</div>
						
						<div id="payments_info" style="padding: 20px; display: <?php echo ($_GET['showPaymentOptions']=='true'?'':'none');?>; background-color: #EEE; border-radius: 1em; box-shadow: #888 6px 6px 15px;; width: 80%">
							<table>
								<tr>
								<td width="500">
									<table>
										<tr>
											<td colspan="3">
												<?php _e('If you want to test this first without involving real money, select "sandbox" and open a Paypal developer account on', 'bachbill');?> <a href="https://developer.paypal.com" target="_blank">https://developer.paypal.com</a><br/><br/>
												<?php _e('If you already tested it and you are good to go live with your website, select "live", open a paypal account at', 'bachbill');?> <a href="http://www.paypal.com" target="_blank">http://www.paypal.com</a> <?php _e('if you do not have it yet and provide us with your API credentials', 'bachbill');?>.<br/><br/>
											</td>
										</tr>
										<tr>
											<td><b><?php _e('Paypal environment', 'bachbill');?></b></td>
											<td><input type="radio" onchange="document.getElementById('paypalLiveConfig').style.display=''; document.getElementById('paypal_live_instructions').style.display=''" name="paypalEnvironment" value="live" <?php if ($paypalEnvironment=='live') echo 'checked="live"';?>/>live <input type="radio" onchange="document.getElementById('paypalLiveConfig').style.display='none'; document.getElementById('paypal_live_instructions').style.display='none'" name="paypalEnvironment" value="sandbox" <?php if ($paypalEnvironment=='sandbox') echo 'checked="sandbox"';?>/>sandbox </td>
											<td></td>
										</tr>
									</table>
									<div id="paypalLiveConfig" style="display: <?php if ($paypalEnvironment=='sandbox') echo 'none'; else echo '';?>">
										<table>
											<tr>
												<td colspan="3"><?php _e('Paypal live configuration', 'bachbill');?></td>
											</tr>
											<tr>
												<td></td>
												<td><?php _e('API Username for live', 'bachbill');?></td>
												<td><input size="30" style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="paypalApiUsername_live" value="<?php echo $paypalApiUsername_live;?>"/></td>
											</tr>
											<tr>
												<td></td>
												<td><?php _e('API Password for live', 'bachbill');?></td>
												<td><input size="30" style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="paypalApiPassword_live" value="<?php echo $paypalApiPassword_live;?>"/></td>
											</tr>
											<tr>
												<td></td>
												<td><?php _e('API Signature for live', 'bachbill');?></td>
												<td><input size="30" style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" name="paypalApiSignature_live" value="<?php echo $paypalApiSignature_live;?>"/></td>
											</tr>
										</table>
									</div>
									</td>
								<td>
									<br/><br/>
									<div id="paypal_live_instructions" style="display: <?php if ($paypalEnvironment=='sandbox') echo 'none'; else echo '';?>">
										<?php _e('You need to have a PayPal account to monetize your contents. You can open an account at', 'bachbill');?> <a href="http://www.paypal.com" target="_blank">http://www.paypal.com</a><br/><br/>
										<?php _e('If you already have a PayPal account, then we need your API credentials. Basically, these are the steps you need to follow to get those credentials', 'bachbill');?>:<br/><br/>
										<ul>
										<li>1. <?php _e('Log in to PayPal, then click Profile under My Account', 'bachbill');?>.</li>
										<li>2. <?php _e('Click My selling tools', 'bachbill');?>.</li>
										<li>3. <?php _e('Click API Access', 'bachbill');?>.</li>
										<li>4. <?php _e('Click Request API Credentials', 'bachbill');?>.</li>
										<li>5. <?php _e('Check Request API signature and click Agree and Submit', 'bachbill');?>.</li>
										</ul>
										<?php _e('For more info please check', 'bachbill');?> <a href="https://cms.paypal.com/us/cgi-bin/?cmd=_render-content&content_ID=developer/e_howto_api_ECAPICredentials" target="_blank"><?php _e('this page', 'bachbill');?></a>
										<br/><br/>
									</div>
								</td>
								</tr>
								</table>
							<table>
								<tr><td><?php _e('Currency', 'bachbill');?>: </td><td>
								<select id="currency" name="currency" value="<?php echo $currency;?>">
									<option value="EUR" title="Û" selected="">EUR</option>
									<option value="THB" title="THB">THB</option>
									<option value="CZK" title="">CZK</option>
									<option value="DKK" title="">DKK</option>
									<option value="NOK" title="">NOK</option>
									<option value="SEK" title="">SEK</option>
									<option value="AUD" title="$">AUD</option>
									<option value="CAD" title="$">CAD</option>
									<option value="HKD" title="$">HKD</option>
									<option value="NZD" title="$">NZD</option>
									<option value="USD" title="$">USD</option>
									<option value="SGD" title="$">SGD</option>
									<option value="HUF" title="">HUF</option>
									<option value="CHF" title="">CHF</option>
									<option value="GBP" title="£">GBP</option>
									<option value="TWD" title="NT$">TWD</option>
									<option value="ILS" title="ILS">ILS</option>
									<option value="PHP" title="P">PHP</option>
									<option value="MXN" title="$">MXN</option>
									<option value="BRL" title="R$">BRL</option>
									<option value="JPY" title="´">JPY</option>
									<option value="PLN" title="">PLN</option>
								</select>
								<script type="text/javascript">document.getElementById("currency").value="<?php echo $currency;?>";</script>
								</td><td> </td></tr>
								<tr><td><?php _e('Tax percentage', 'bachbill');?>: </td><td><input style="border: 2px solid #0088dd; background-color: #eeeeee" type="text" size="4" name="taxPercentage" value="<?php echo $taxPercentage?$taxPercentage:'0';?>"/></td><td> </td></tr>
							</table>
							<br/>
							<table width="100%">
							<tr><td align="left" colspan="3"><input class="button-primary" type="submit" value="<?php _e('Update configuration', 'bachbill');?>"/></td></tr>
							</table>
						</div>
						
						<div id="social_info" style="padding: 20px; display:none; background-color: #EEE; border-radius: 1em; box-shadow: #888 6px 6px 15px; width: 80%">
							<table>
							<tr>
								<td colspan="10">
									<?php _e('You can choose as many social networks as you want from below. This way, the user will be able to sign up to your site using that social network account', 'bachbill');?><br/><br/>
									<?php _e('You can also select none and manage your customers just us regular wordpress users', 'bachbill');?>.<br/><br/>
								</td>
							</tr>
							<?php
							global $SOCIAL_NETWORK_NAMES;
							global $SOCIAL_NETWORK_ICONS;
							$i=0;
							foreach ($socialNetworks as $key=>$value) {
//								if ($i % 35 ==0){
//									echo '<tr>';
//								}
								echo '<td align="right"><input type="checkbox" style="width: 10px; vertical-align: middle;" name="'.$key.'" '.($value?'checked="checked"':'').'></td><td><img style="vertical-align: middle" src="../wp-content/plugins/a-dime-every-time/img/'.$SOCIAL_NETWORK_ICONS[$key].'"><br/><br/></input></td>';
//								if ($i % 35==1){
//									echo '</tr>';
//								}
								$i++;
							}
							?>
							</table>
							
							<table width="100%">
							<tr><td align="left" colspan="3"><input class="button-primary" type="submit" value="<?php _e('Update configuration', 'bachbill');?>"/></td></tr>
							</table>
						</div>
						<br/>
					</form>
					<br/><br/><br/>
					
					<input type="button" name="" class="button-secondary action" value="<?php _e('Reset account information', 'bachbill');?>" onClick="resetConfig()">
					
				<?php
			}
		
		?>
		</div>
		<?php 
	}


?>